# Architecture Overview

This document provides a high-level overview of the Cribl Pipeline Visualizer architecture.

## Introduction

The Cribl Pipeline Visualizer is a web application designed to help users understand their Cribl Stream configuration by visualizing the relationships between inputs, pipelines, and outputs. It connects to a running Cribl Stream instance, retrieves the configuration via the API, and renders a directed graph.

## System Components

The system consists of the following key components:

### 1. Flask Application (`app.py`)
-   **Role**: The web server and entry point.
-   **Functionality**:
    -   Serves the main page (`/`).
    -   Orchestrates the data fetching and graph generation process.
    -   Handles errors and renders appropriate templates.
    -   Caches the API client instance to reuse authentication tokens.

### 2. Cribl API Client (`cribl_api.py`)
-   **Role**: The interface to the Cribl Stream API.
-   **Functionality**:
    -   Handles authentication (Token-based or Username/Password).
    -   Manages HTTP sessions and headers.
    -   Provides methods to fetch worker groups, inputs, outputs, and pipelines.
    -   Abstracts away the low-level HTTP details.

### 3. Graph Generator (`graph_generator.py`)
-   **Role**: The logic for transforming configuration data into a visual graph.
-   **Functionality**:
    -   Uses the `graphviz` Python library to build a DOT graph.
    -   Iterates through worker groups, inputs, and outputs.
    -   Draws nodes for inputs (blue) and outputs (green).
    -   Draws edges representing pipelines based on input connections.
    -   Appends descriptions to node labels for better context.

### 4. Graphviz (System Dependency)
-   **Role**: The rendering engine.
-   **Functionality**:
    -   Takes the DOT source generated by the Python library.
    -   Renders it into an SVG image that can be displayed in a browser.

## Data Flow

1.  **User Request**: A user accesses the application URL (`/`).
2.  **API Client Initialization**: The app retrieves the cached `CriblAPI` client (or creates one if it doesn't exist).
3.  **Data Retrieval**:
    -   `get_worker_groups()` is called to find all worker groups.
    -   For each group, `get_sources()` and `get_destinations()` are called to fetch the configuration.
4.  **Graph Construction**:
    -   `graph_generator.py` processes the data.
    -   It creates a subgraph for each worker group.
    -   It adds nodes for inputs and outputs.
    -   It adds edges for connections found in the input configurations.
5.  **Rendering**: The graph is piped to the `dot` command to generate an SVG string.
6.  **Response**: The SVG is embedded in `index.html` and returned to the user's browser.

## Deployment Strategy

The application is designed to be deployed as a Docker container.

-   **Dockerfile**: Builds a Python environment with necessary dependencies (`Flask`, `graphviz`, `requests`). It also installs the system-level `graphviz` package.
-   **Docker Compose**: Orchestrates the deployment, mapping port 5000 (container) to 8080 (host). It also allows for easy environment variable configuration via a `.env` file.

## Directory Structure

-   `app.py`: Main application logic.
-   `cribl_api.py`: API interaction layer.
-   `graph_generator.py`: Graph creation logic.
-   `templates/`: HTML templates.
-   `docs/`: Documentation files.
-   `tests/`: Unit tests.
